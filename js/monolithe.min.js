var mnlt,noticesCtrl,noticesFactory;mnlt=angular.module("mnlt",["filters","directives","ngSanitize"]),mnlt.config(function($httpProvider){delete $httpProvider.defaults.headers.common["X-Requested-With"]}),mnlt.controller("noticesCtrl",noticesCtrl=function($scope,$http,$sce,$timeout){var sep="\n------------------------------------------------";Storage.prototype.setObj=function(key,obj){return this.setItem(key,JSON.stringify(obj))},Storage.prototype.getObj=function(key){return JSON.parse(this.getItem(key))};var d=new Date,day=d.getDay(),month=d.getMonth(),year=d.getFullYear(),sp="/",date=day+sp+month+sp+year;if(localStorage.getItem("date")!=date?(localStorage.clear(),console.log("LOCALSTORAGE CLEARED"),localStorage.setItem("date",date),console.log("SETING DATE LOCALSTORAGE : "+date+sep)):console.log("GETING DATE LOCALSTORAGE : "+date+sep),$scope.currentLang="",$scope.langN="fr",$scope.templates={fr:[{name:"grandes dates",slug:"grandes-dates",url:"templates/grandes-dates.html"},{name:"histoire",slug:"histoire",url:"templates/histoire.html"},{name:"personnalités",slug:"personnalites",url:"templates/personnalites.html"},{name:"thèmes",slug:"themes",url:"templates/themes.html"},{name:"art - patrimoine",slug:"art-patrimoine",url:"templates/art-patrimoine.html"}],en:[{name:"major dates",slug:"significant-dates",url:"templates/grandes-dates.html"},{name:"history",slug:"history",url:"templates/histoire.html"},{name:"key figures",slug:"personnalities",url:"templates/personnalites.html"},{name:"themes",slug:"themes-en",url:"templates/themes.html"},{name:"art - heritage",slug:"art-heritage",url:"templates/art-patrimoine.html"}],de:[{name:"eckdaten",slug:"wichtige-daten",url:"templates/grandes-dates.html"},{name:"geschichte",slug:"geschichte",url:"templates/histoire.html"},{name:"persönlichkeiten",slug:"personlichkeiten",url:"templates/personnalites.html"},{name:"themen",slug:"themen",url:"templates/themes.html"},{name:"kunst und erbe",slug:"kunst-kulturerbe",url:"templates/art-patrimoine.html"}]},$scope.currentParam=1,$scope.template=$scope.templates[$scope.langN][$scope.currentParam],$scope.isActive=function(item){return item.slug==$scope.template.slug?!0:!1},$scope.getTemplate=function(param){$scope.currentParam=param,$scope.template=$scope.templates[$scope.langN][param]},$scope.getLang=function(lang){$scope.langN=""==lang.slice(1,3)?"fr":lang.slice(1,3),$scope.currentLang=lang},$scope.getNotices=function(name,lang){$(".loader").css({display:"block"}),$scope.bullets=[],$scope.notices=[],null!=localStorage.getItem(name+lang.slice(1,3))&&void 0!=typeof localStorage?(console.log("GETING THE LOCALSTORAGE FOR : "+name+" AND LANG : "+lang.slice(1,3)+sep),$scope.notices=localStorage.getObj(name+lang.slice(1,3)),$(".loader").css({display:"none"}),$timeout(function(){$(".templates").fadeIn()},200)):(console.log("SETING THE LOCALSTORAGE FOR : "+name+" AND LANG : "+lang.slice(1,3)+sep),$http.jsonp("http://mvpf.phpnet.org/museevirtuelprotestant"+lang+"/api/get_posts/?post_type=notice&rubriques="+name+"&custom_fields=none&count=-1&callback=JSON_CALLBACK").success(function(data){0!=data.count?(console.log("LOCALSTORAGE DONE"+sep),$(".loader").css({display:"none"}),$(".templates").fadeIn(),localStorage.setObj(name+lang.slice(1,3),data.posts),$scope.notices=data.posts):(console.log("NO NOTICES WITHIN : "+name+sep),$scope.notices="")})),$scope.currentCat=name,$scope.currentLang=lang},$scope.$watchCollection("[template.slug, currentLang]",function(){$scope.template=$scope.templates[$scope.langN][$scope.currentParam],$scope.getNotices($scope.template.slug,$scope.currentLang)}),$scope.alphabet=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],$scope.getLetter=function(input){$scope.letter=input},$scope.$watch("letter",function(){$(".filter-alphabet li").removeClass("activeLetter"),$(".resetLetter").css({opacity:"0"}),null!=$scope.letter&&void 0!=$scope.letter&&""!=$scope.letter&&($('.filter-alphabet li:contains("'+$scope.letter+'")').addClass("activeLetter"),$(".resetLetter").css({opacity:"1"}))}),$scope.getCenturies=function(lang){console.log("GETING CENTURIES"+sep),$http.jsonp("http://mvpf.phpnet.org/museevirtuelprotestant"+lang+"/api/taxonomy/get_taxonomy_index/?taxonomy=siecles&callback=JSON_CALLBACK").success(function(data){for(var centuries=[],i=0;i<data.terms.length;i++)centuries.push(data.terms[i]);console.log("CENTURIES DONE"+sep),$scope.centuriesList=centuries})},$scope.$watch("currentLang",function(){$scope.getCenturies($scope.currentLang)}),$scope.getThemes=function(name,lang){$http.jsonp("http://mvpf.phpnet.org/museevirtuelprotestant"+lang+"/api/taxonomy/get_taxonomy_index/?taxonomy="+name+"&callback=JSON_CALLBACK").success(function(data){for(var themes=[],i=0;i<data.terms.length;i++)themes.push(data.terms[i]);$scope.themesList=themes})},$scope.$watchCollection("[template.slug, currentLang]",function(){$scope.themesList=$scope.getThemes($scope.templates.fr[$scope.currentParam].slug,$scope.currentLang)}),genPagination=function(limit,data){var pages=Math.ceil(data.length/$scope.limit);if(pages){$scope.bullets=[];for(var i=1;pages>=i;i++){var lastCount=data.length%$scope.limit;$scope.bullets.push(i==pages&&0!=lastCount?data.length%$scope.limit:$scope.limit)}}},$scope.$watch("template",function(){switch($scope.template.slug){case"histoire":$scope.limit=window.innerHeight<800?6:9;break;case"personnalites":$scope.limit=window.innerHeight<800?4:8;break;case"themes":$scope.limit=window.innerHeight<800?4:6;break;case"art-patrimoine":$scope.limit=window.innerHeight<800?4:6}}),$scope.pager=function(num,limit){$scope.pageIndex=num,$scope.pageLimit=-limit},$scope.pagSelected=0,$scope.pagClicked=function($index){$scope.pagSelected=$index},$scope.reset=function(){$scope.pager($scope.limit,$scope.limit),$scope.search="",$scope.letter=!1,$scope.century=!1,$scope.cursorValues=!1,$scope.pagSelected=0},$scope.$watchCollection("[currentCat, currentLang]",function(){$scope.reset()}),$scope.$watchCollection("[filtered.length, currentLang, template.slug]",function(){void 0!=$scope.filtered&&null!=$scope.filtered&&($scope.pagSelected=0,$scope.pager($scope.limit,$scope.limit),genPagination($scope.limit,$scope.filtered))}),$timeout(function(){var currentUrl=window.parent.location.href,regEn=/\/en\//,regDe=/\/de\//;$scope.getLang(regEn.test(currentUrl)?"/en":regDe.test(currentUrl)?"/de":"")},200),$("body").append('<div id="dialog" title="MVPF"><img style="-webkit-user-select: none" src="http://media.giphy.com/media/13SbGD4j7TlqZG/giphy.gif"></div> '),$("#dialog").dialog({autoOpen:!1,width:400}),window.addEventListener){var kkeys=[],konami="38,38,40,40,37,39,37,39,66,65";window.addEventListener("keydown",function(e){kkeys.push(e.keyCode),kkeys.toString().indexOf(konami)>=0&&($("#dialog").dialog("open"),kkeys=[])},!0)}});
var direct=angular.module("directives",[]);direct.directive("cursor",function(){return{restrict:"E",template:'<div id="slider"></div><div class="legend"></div>',controller:function($scope,$timeout){$scope.$watch("centuriesList",function(){if(void 0!=$scope.centuriesList&&null!=$scope.centuriesList){var centuriesList=$scope.centuriesList,getCenturies=function(min,max){for(var out=[],i=0;i<centuriesList.length;i++)i>=min&&max>=i&&out.push(centuriesList[i].slug);$scope.$apply(function(){$scope.cursorValues=out})};$("#slider").slider({range:!0,min:0,max:centuriesList.length-1,values:[0,centuriesList.length-1],slide:function(event,ui){getCenturies(ui.values[0],ui.values[1])}}),$timeout(function(){var cursorW=$(".legend").width();$(".legend").empty();for(var i=0;i<centuriesList.length;i++){var reg=new RegExp("e siècle");$(".legend").append("<span>"+centuriesList[i].title.split(reg)[0]+" <sup>ème</sup></span>")}$(".legend span").each(function(index){var centuryW=$(this).width()/2/cursorW*100,posX=100*(cursorW/(centuriesList.length-1))/cursorW*index-centuryW;$(this).css({left:posX+"%"})})},300)}})}}}),direct.directive("sidemenu",function(){return{restrict:"E",template:'<div class="filters"><ul class="menu-themes"></ul></div>',controller:function($scope,$compile){$scope.$watch("themesList",function(){var themesList=[],themes=[];if(void 0!=$scope.themesList&&null!=$scope.themesList){themesList=$scope.themesList,themes=[],$(".menu-themes li").remove();for(var i=0;i<themesList.length;i++)0==themesList[i].parent&&(themes.push(themesList[i]),document.querySelectorAll(".menu-themes")[0].innerHTML+="<li><a title='"+themesList[i].title+"' ng-click=getLetter('"+themesList[i].slug+"')>"+themesList[i].title+"</a></li>");for(var i=0;i<themes.length;i++){document.querySelectorAll(".menu-themes > li")[i].innerHTML+="<ul class='submenu'></ul>";for(var j=0;j<themesList.length;j++)themesList[j].parent==themes[i].id&&(document.querySelectorAll(".menu-themes > li .submenu")[i].innerHTML+="<li><a id='"+themesList[j].slug+"' ng-click=getLetter('"+themesList[j].slug+"')>"+themesList[j].title+"</a></li>",$compile(document.querySelectorAll(".menu-themes > li .submenu")[i])($scope))}$compile(document.querySelectorAll(".menu-themes")[0])($scope),$(".menu-themes > li .submenu li").parent().parent().addClass("parentsThemes"),$(".submenu").hide(),$(".parentsThemes > a").click(function(){$(this).parents("li").children(".submenu").stop(),$(this).parents("li").siblings("li").removeClass("active"),$(this).parents("li").toggleClass("active"),$(this).parents("li").siblings("li").children(".submenu").slideUp(),$(this).parents("li").children(".submenu").slideToggle()}),$(".submenu > li").click(function(){$(".submenu > li").removeClass("active"),$(this).addClass("active")})}}),$scope.$watch("letter",function(){0==$scope.letter&&$(".submenu > li").removeClass("active")})}}}),direct.directive("timeline",function(){return{restrict:"E",template:'<div id="my-timeline"></div>',controller:function($scope){$scope.$watch("notices",function(){if(void 0!=$scope.notices&&null!=$scope.notices&&"grandes-dates"===$scope.template.slug&&$scope.notices.length>0){for(var notices=$scope.notices,dataObject={timeline:{type:"default",date:[]}},i=0;i<notices.length;i++)dataObject.timeline.date[i]={},dataObject.timeline.date[i].startDate=notices[i].date_start,dataObject.timeline.date[i].endDate=notices[i].date_end,dataObject.timeline.date[i].headline=notices[i].title,dataObject.timeline.date[i].text=notices[i].chapeau,dataObject.timeline.date[i].asset={},dataObject.timeline.date[i].asset.media=notices[i].images.large;setTimeout(function(){createStoryJS({type:"timeline",width:"100%",height:"680",source:dataObject,start_at_slide:"0",embed_id:"my-timeline",lang:"fr",start_zoom_adjust:"1"})},200)}})}}});
var filt=angular.module("filters",[]),cleanArray=function(input){for(var list=[],currentId="",out=[],i=0;i<input.length;i++)list.push(input[i].id);list=list.sort();for(var i=0;i<list.length;i++)list[i]==currentId&&list.splice(i,1),currentId=list[i];for(var i=0;i<list.length;i++)out.push(input[i]);return out};filt.filter("regex",function(){return function(input,field,regex){if(0!=regex&&null!=regex){var out=[];if("object"==typeof regex)for(var reg=[],i=0;i<regex.length;i++)reg=new RegExp("^"+regex[i]),testReg(input,field,reg,out);else{var reg=new RegExp("^"+regex);testReg(input,field,reg,out)}return cleanArray(out)}return input}});var testReg=function(input,field,reg,out){for(var k=0;k<input.length;k++)if("object"==typeof input[k][field])for(var l=0;l<input[k][field].length;l++)reg.test(input[k][field][l].slug)&&out.push(input[k]);else reg.test(input[k][field])&&out.push(input[k])};